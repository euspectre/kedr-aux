/*
 * Internal representation of trace files generated by lcov.
 *
 * This is simple variant, which contains only files information (SF) but looses original test (TN) division.
 */

#ifndef TRACE_SIMPLE_H_INCLUDED
#define TRACE_SIMPLE_H_INCLUDED

#include <iostream>

#include <string>
#include <map>

class TraceParser;

struct TraceSimple
{
	/* Type used for counters. */
	typedef long counter_t;
	
	TraceSimple();
	
	/* 
	 * Load trace from the stream.
	 * 
	 * If non-empty, 'filename' is used for error reporting.
	 */
	void read(std::istream& is, const char* filename = "");
	/* Same but use already existed parser instead of create new one. */
	void read(std::istream& is, TraceParser& parser, const char* filename = "");
	/* Load trace from file. */
	void read(const char* filename);
	void read(const char* filename, TraceParser& parser);

	/* Store trace to the stream */
	void write(std::ostream& os) const;


	struct FuncInfo;
	struct BranchID;
	struct FileInfo;
	
	/* 
	 * Trace consists from files.
	 * 
	 * Files are delimited with "SN:" directive in the trace file.
	 * Every file is assumed to be a single file in the test ("TN:").
	 */
	std::map<std::string, FileInfo> files;
	
	/* 
	 * Make every group to contain only one file.
	 * 
	 * Do nothing for the given class.
	 */
	void groupFiles(void) {};

	/* 
	 * Useful functions for calculate statistic for all files.
	 * 
	 * NOTE: Theese functions assume files with same names different,
	 * if they belong to file groups with difference name. So, statistic
	 * for such files sums instead of joined.
	 * 
	 * If you want to assume files with same name identical, use
	 * groupFiles() method before call these functions.
	 */
	int linesTotal(void) const;
	int linesTotalHit(void) const;

	int branchesTotal(void) const;
	int branchesTotalHit(void) const;

	int functionsTotal(void) const;
	int functionsTotalHit(void) const;
	
	/* 
	 * Return common prefix for all sources.
	 * 
	 * For empty trace return "".
	 */
	std::string commonSourcePrefix(void) const;
	
	/* Keep only sources with given prefix, other sources are removed. */
	void filterSources(const std::string& prefix);
private:
	class TraceBuilder;
};

/* Information about function in file */
struct TraceSimple::FuncInfo
{
	/* 
	 * Line where function starts.
	 * 
	 * Sometimes, gcov misses definition of function, while define
	 * counter for it.
	 * It may occure, e.g., when inline function calls another
	 * inline function: in that case line for caller is not defined
	 * in trace file, but counter is.
	 * Value -1 is used for signal that situation.
	 */
	int lineStart;
	/* Hit counter for function */
	counter_t counter;
	
	/* 'counter should be set after constructor '*/
	FuncInfo(int lineStart): lineStart(lineStart) {}
};

/* Branch identificator in the file */
struct TraceSimple::BranchID
{
	/* Line of the branch in the file */
	int line;
	/* 
	 * Block and branch numbers - gcov internals for uniquely
	 * identify branch.
	 */
	int blockNumber;
	int branchNumber;
	
	BranchID(int line, int blockNumber, int branchNumber):
		line(line), blockNumber(blockNumber), branchNumber(branchNumber) {}

	/* This operator allows to use branch identificator as key in map. */
	bool operator<(const BranchID& branchID) const;
	/* Simple pretty-printing for error reporting */
	friend std::ostream& operator<<(std::ostream& os, const Trace::BranchID& branchID);
};

/* Information about one file(source or header) in trace */
struct TraceSimple::FileInfo
{
	/* Function information for each function name in file. */
	std::map<std::string, FuncInfo> functions;
	/* Counter for each line in file. */
	std::map<int, counter_t> lines;
	/* 
	 * Counter for each branch in file.
	 * 
	 * value -1 corresponds to '-' in BRDA directive in trace file.
	 */
	std::map<BranchID, counter_t> branches;
	
	/* Useful functions for calculate per-file statistic */
	int linesTotal(void) const;
	int linesTotalHit(void) const;

	int branchesTotal(void) const;
	int branchesTotalHit(void) const;

	int functionsTotal(void) const;
	int functionsTotalHit(void) const;
};


#endif /* TRACE_SIMPLE_H_INCLUDED */
